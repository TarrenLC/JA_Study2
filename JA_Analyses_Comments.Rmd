---
title: "JA_Analyses_Comments"
author: "T.L"
date: "2022-09-12"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


# Packages
```{r}

library(rstatix) # Basic analyses like ANOVA etc

library(lme4) # For multilevel models

library(lmerTest) # For lmm p-values

#FLEXPLOT# if not already installed use devtools::install_github("dustinfife/flexplot")

library(flexplot)

library(tidyverse) # For pivotting longer etc

library(sjPlot) #for exporting nice tables of our output

library(flextable) #another package to make apa tables

library(robustlmm) #For robust lmm when normality violated

library(multilevelTools) 

library(JWileymisc) # To use modelDiagnostics

library(ggpubr) # Plotting

library(reghelper)  #for probing interactions

# library(visreg) # Plotting linear regression models

library(emmeans) # to follow up on sig mixed models interactions

library(Hmisc) # Correlation analyses

library(knitr) # For printing nice tables

```


# Load in data
```{r}

load(file = "Judge_Advisor_2022_preprocessed.RData")

#turning off scientific notation 
options(scipen=999)

```

# Getting to know the data
## Visualisations
```{r}
# DASS by Age

flexplot(DASS~AGEn, data=full_ja_df)

# AvFluidIQ by Age

flexplot(AVFLUIDIQ~AGEn, data=full_ja_df)

# Perceived Advice Accuracy by Age

flexplot(PERCEIVED_ADVICE_ACCURACYn~AGEn, data=full_ja_df)


# Pre confidence by Age

flexplot(PRE_CONFIDENCEn~AGEn, data=full_ja_df)

# Post confidence by Age

flexplot(PRE_CONFIDENCEn~AGEn, data=full_ja_df)

# Emotion regulation by Age

flexplot(AGEn~EMO_REGn, data=full_ja_df)

# Emotion regulation effort by Age

flexplot(EMO_REG_EFFORT1n~AGEn, data=full_ja_df)

flexplot(EMO_REG_EFFORT2n~AGEn, data=full_ja_df)


```



# Opinion difference
## Get to know the data
```{r}

### Put data in a long dataframe

pracs <- select(full_ja_df, ID, AGEGROUP, PRAC1_1n, PRAC1_2n, PRAC1_3n)

pracs$ID <- as.factor(pracs$ID)

# Actual prac jars values
## Jar 1 = 188
## Jar 2 = 141
## Jar 3 = 71

# Create opinion difference scores (initial minus actual coins)
pracs <- pracs %>% 
  rowwise() %>% 
  mutate(PRAC1_OP = PRAC1_1n-188)

pracs <- pracs %>% 
  rowwise() %>% 
  mutate(PRAC2_OP = PRAC1_2n-141)

pracs <- pracs %>% 
  rowwise() %>% 
  mutate(PRAC3_OP = PRAC1_3n-71)

pracs <-  pivot_longer(pracs, cols = c("PRAC1_OP", "PRAC2_OP","PRAC3_OP"), 
                      names_to = "PRACTICE_TRIAL", values_to = "OPINIONDIFF")

pracs$PRACTICE_TRIAL <- as.factor(pracs$PRACTICE_TRIAL)

levels(pracs$PRACTICE_TRIAL)


# Look at some visualisations
flexplot(OPINIONDIFF~1, data=pracs)

flexplot(OPINIONDIFF~AGEGROUP, data=pracs)

flexplot(OPINIONDIFF~PRACTICE_TRIAL, data=pracs)

flexplot(OPINIONDIFF~PRACTICE_TRIAL + AGEGROUP, data=pracs)

flexplot(OPINIONDIFF~PRACTICE_TRIAL | AGEGROUP, data=pracs)

## Appears to be some extreme outliers.
pracs %>% 
  group_by(AGEGROUP) %>%
  identify_outliers(OPINIONDIFF) # 8 outliers...


```

### Adjust outliers +/- 3SDs from M
```{r}
# Put data back to wide

pracs <- spread(pracs, PRACTICE_TRIAL, OPINIONDIFF)

summarystats_op <- pracs %>% 
  group_by(AGEGROUP) %>%
  get_summary_stats(PRAC1_OP, PRAC2_OP, PRAC3_OP, type = "mean_sd")

ungroup(pracs)

summarystats_op$M_PLUS_3SD <- summarystats_op$mean + (3*summarystats_op$sd)

summarystats_op$M_MINUS_3SD <- summarystats_op$mean - (3*summarystats_op$sd)

## Split into age groups
young <- subset(pracs, AGEGROUP == "YOUNG")

middle <- subset(pracs, AGEGROUP == "MIDDLE")

older <- subset(pracs, AGEGROUP == "OLDER")

```


#### Younger adults
```{r}

# Change outliers to 5000 if above M+3*SDs
# Change outliers to -5000 if below M-3*SDs 
# Easy to identify and sort out from other values

young <- young %>%
  mutate(PRAC1_OP = ifelse(is.na(PRAC1_OP), NA,
                             ifelse(PRAC1_OP > 402.353, 5000, PRAC1_OP)), # 1 identified
         PRAC1_OP = ifelse(is.na(PRAC1_OP), NA,
                             ifelse(PRAC1_OP < -518.353, -5000, PRAC1_OP))) 

young <- young %>%
  mutate(PRAC2_OP = ifelse(is.na(PRAC2_OP), NA,
                             ifelse(PRAC2_OP > 449.818, 5000, PRAC2_OP)), # 1 identified
         PRAC2_OP = ifelse(is.na(PRAC2_OP), NA,
                             ifelse(PRAC2_OP < -488.600, -5000, PRAC2_OP)),
         PRAC3_OP= ifelse(is.na(PRAC3_OP), NA,
                             ifelse(PRAC3_OP > 237.886, 5000, PRAC3_OP)), # 1 identified
         PRAC3_OP = ifelse(is.na(PRAC3_OP), NA,
                             ifelse(PRAC3_OP < -259.460, -5000, PRAC3_OP))) 

## Create new df without the outliers

young_exl_out <- select(young, PRAC1_OP, PRAC2_OP, PRAC3_OP)

young_exl_out <- young_exl_out %>%
  mutate(PRAC1_OP = ifelse(is.na(PRAC1_OP), NA,
                             ifelse(PRAC1_OP == 5000 |PRAC1_OP == -5000, as.integer(NA), PRAC1_OP)),
         PRAC2_OP = ifelse(is.na(PRAC2_OP), NA,
                             ifelse(PRAC2_OP == 5000 |PRAC2_OP == -5000, as.integer(NA), PRAC2_OP)),
         PRAC3_OP = ifelse(is.na(PRAC3_OP), NA,
                             ifelse(PRAC3_OP == 5000 |PRAC3_OP == -5000, as.integer(NA), PRAC3_OP)))

youngmsd <- young_exl_out %>% 
  get_summary_stats(PRAC1_OP, PRAC2_OP, PRAC3_OP, type = "mean_sd")

youngmsd$M_PLUS_3SD <- youngmsd$mean + (3*youngmsd$sd)

# Replace the values taken

young <- young %>%
  mutate(PRAC1_OP = ifelse(is.na(PRAC1_OP), NA,
                             ifelse(PRAC1_OP == 5000, 172.012, PRAC1_OP)),
         PRAC2_OP = ifelse(is.na(PRAC2_OP), NA,
                             ifelse(PRAC2_OP == 5000, 213.740, PRAC2_OP)),
         PRAC3_OP = ifelse(is.na(PRAC3_OP), NA,
                             ifelse(PRAC3_OP == 5000, 97.689, PRAC3_OP)))

```


#### Middle-aged adults
```{r}

# Change outliers to 5000 if above M+3*SDs
# Change outliers to -5000 if below M-3*SDs 
# Easy to identify and sort out from other values

middle <- middle %>%
  mutate(PRAC1_OP = ifelse(is.na(PRAC1_OP), NA,
                             ifelse(PRAC1_OP > 973.971, 5000, PRAC1_OP)), # 1 identified
         PRAC1_OP = ifelse(is.na(PRAC1_OP), NA,
                             ifelse(PRAC1_OP < -1002.711, -5000, PRAC1_OP)),
         PRAC2_OP = ifelse(is.na(PRAC2_OP), NA,
                             ifelse(PRAC2_OP > 1007.667, 5000, PRAC2_OP)), # 1 identified
         PRAC2_OP = ifelse(is.na(PRAC2_OP), NA,
                             ifelse(PRAC2_OP < -972.705, -5000, PRAC2_OP)),
         PRAC3_OP = ifelse(is.na(PRAC3_OP), NA,
                             ifelse(PRAC3_OP > 197.910, 5000, PRAC3_OP)), # 1 identified
         PRAC3_OP = ifelse(is.na(PRAC3_OP), NA,
                             ifelse(PRAC3_OP < -211.836, -5000, PRAC3_OP))) 

## Create new df without the outliers

middle_exl_out <- select(middle, PRAC1_OP, PRAC2_OP, PRAC3_OP)

middle_exl_out <- middle_exl_out %>%
  mutate(PRAC1_OP = ifelse(is.na(PRAC1_OP), NA,
                             ifelse(PRAC1_OP == 5000 |PRAC1_OP == -5000, as.integer(NA), PRAC1_OP)),
         PRAC2_OP = ifelse(is.na(PRAC2_OP), NA,
                             ifelse(PRAC2_OP == 5000 |PRAC2_OP == -5000, as.integer(NA), PRAC2_OP)),
         PRAC3_OP = ifelse(is.na(PRAC3_OP), NA,
                             ifelse(PRAC3_OP == 5000 |PRAC3_OP == -5000, as.integer(NA), PRAC3_OP)))

middlemsd <- middle_exl_out %>% 
  get_summary_stats(PRAC1_OP, PRAC2_OP, PRAC3_OP, type = "mean_sd")

middlemsd$M_PLUS_3SD <- middlemsd$mean + (3*middlemsd$sd)


# Replace the values taken

middle <- middle %>%
  mutate(PRAC1_OP = ifelse(is.na(PRAC1_OP), NA,
                             ifelse(PRAC1_OP == 5000, 144.812, PRAC1_OP)),
         PRAC2_OP = ifelse(is.na(PRAC2_OP), NA,
                             ifelse(PRAC2_OP == 5000, 153.545, PRAC2_OP)),
         PRAC3_OP = ifelse(is.na(PRAC3_OP), NA,
                             ifelse(PRAC3_OP == 5000, 81.057, PRAC3_OP)))

```


#### Older adults
```{r}
# Change outliers to 5000 if above M+3*SDs
# Change outliers to -5000 if below M-3*SDs 
# Easy to identify and sort out from other values

older<- older %>%
  mutate(PRAC1_OP = ifelse(is.na(PRAC1_OP), NA,
                             ifelse(PRAC1_OP > 86.898, 5000, PRAC1_OP)), # No outliers
         PRAC1_OP = ifelse(is.na(PRAC1_OP), NA,
                             ifelse(PRAC1_OP < -259.734, -5000, PRAC1_OP)),
         PRAC2_OP = ifelse(is.na(PRAC2_OP), NA,
                             ifelse(PRAC2_OP > 107.020, 5000, PRAC2_OP)), # 1 identified
         PRAC2_OP = ifelse(is.na(PRAC2_OP), NA,
                             ifelse(PRAC2_OP < -218.474, -5000, PRAC2_OP)),
         PRAC3_OP = ifelse(is.na(PRAC3_OP), NA,
                             ifelse(PRAC3_OP > 56.977, 5000, PRAC3_OP)), # 1 identified
         PRAC3_OP = ifelse(is.na(PRAC3_OP), NA,
                             ifelse(PRAC3_OP < -113.495, -5000, PRAC3_OP))) 


## Create new df without the outliers

older_exl_out <- select(older, PRAC1_OP, PRAC2_OP, PRAC3_OP)

older_exl_out <- older_exl_out %>%
  mutate(PRAC1_OP = ifelse(is.na(PRAC1_OP), NA,
                             ifelse(PRAC1_OP == 5000 |PRAC1_OP == -5000, as.integer(NA), PRAC1_OP)),
         PRAC2_OP = ifelse(is.na(PRAC2_OP), NA,
                             ifelse(PRAC2_OP == 5000 |PRAC2_OP == -5000, as.integer(NA), PRAC2_OP)),
         PRAC3_OP = ifelse(is.na(PRAC3_OP), NA,
                             ifelse(PRAC3_OP == 5000 |PRAC3_OP == -5000, as.integer(NA), PRAC3_OP)))

oldermsd <- older_exl_out %>% 
  get_summary_stats(PRAC1_OP, PRAC2_OP, PRAC3_OP, type = "mean_sd")

oldermsd$M_PLUS_3SD <- oldermsd$mean + (3*oldermsd$sd)


# Replace the values taken

older <- older %>%
  mutate(PRAC1_OP = ifelse(is.na(PRAC1_OP), NA,
                             ifelse(PRAC1_OP == 5000, 86.898, PRAC1_OP)),
         PRAC2_OP = ifelse(is.na(PRAC2_OP), NA,
                             ifelse(PRAC2_OP == 5000, 71.314, PRAC2_OP)),
         PRAC3_OP = ifelse(is.na(PRAC3_OP), NA,
                             ifelse(PRAC3_OP == 5000, 29.254, PRAC3_OP)))

```

### Combine adjusted value dfs
```{r}

# Combine the age group dfs together

all_ages <- young %>% full_join(middle)
  
all_ages <- all_ages %>% full_join(older)

pracs <- all_ages

```


## Opinion difference between age groups
```{r}

# Put data back into long form
pracs <-  pivot_longer(pracs, cols = c("PRAC1_OP", "PRAC2_OP","PRAC3_OP"), 
                      names_to = "PRACTICE_TRIAL", values_to = "OPINIONDIFF")

pracs$PRACTICE_TRIAL <- as.factor(pracs$PRACTICE_TRIAL)

levels(pracs$PRACTICE_TRIAL)

# Visualisation of data
flexplot(OPINIONDIFF~PRACTICE_TRIAL | AGEGROUP, data=pracs) # Looks better

## Analyses

op.aov <- anova_test(
  data = pracs, dv = OPINIONDIFF, wid = ID,
  between = AGEGROUP,
  within = PRACTICE_TRIAL,
  effect.size = "pes"
  )

get_anova_table(op.aov)

pracs %>% group_by(PRACTICE_TRIAL) %>% 
  get_summary_stats(OPINIONDIFF, type = "mean_sd")

ungroup(pracs)

# Pairwise comparisons between practice trials

practrial <- pracs %>%
  pairwise_t_test(
    OPINIONDIFF ~ PRACTICE_TRIAL, paired = TRUE,
    p.adjust.method = "bonferroni"
    )
practrial

# Pairwise comparisons between the age groups

pracages <- pracs %>%
  pairwise_t_test(
    OPINIONDIFF ~ AGEGROUP, 
    p.adjust.method = "bonferroni"
    )

pracages

avg_grp_op <- pracs %>% group_by(AGEGROUP) %>% 
  get_summary_stats(OPINIONDIFF, type = "mean_sd")


## Create descriptives table of opinion differences by age groups

avg_grp_op <- select(avg_grp_op, AGEGROUP, n, mean, sd)

avg_grp_op$AGEGROUP <- recode_factor(avg_grp_op$AGEGROUP,YOUNG = "Young adults", 
                                     MIDDLE = "Middle-aged adults",
                                     OLDER = "Older adults")

## change the descriptives df to 2 decimal places
avg_grp_op$mean <- format(round(avg_grp_op$mean,2))
avg_grp_op$sd <- format(round(avg_grp_op$sd,2))
  
avg_grp_op_table <- flextable(avg_grp_op) 


# Make new column names
avg_grp_op_table <- avg_grp_op_table %>% 
  
   set_header_labels(         # Rename the columns in original header row
      AGEGROUP = "Age group", 
      n = "N",                  
      mean = "M",
      sd = "SD")




avg_grp_op_table <- align(avg_grp_op_table, align = "center", j = 2:4,
                          part = "all")

avg_grp_op_table %>% autofit() # Auto fits the columns

save_as_docx("age group averages" = avg_grp_op_table, path = "file.docx")

```


# Check age group differences
## Depressive symptom score
```{r}

levels(full_ja_df$AGEGROUP)

ungroup(full_ja_df)

dep_diff <- full_ja_df %>%
  anova_test(DASS~AGEGROUP)

dep_diff

full_ja_df %>% tukey_hsd(DASS~AGEGROUP)

dep_diff_lm <- lm(DASS~AGEGROUP, data = full_ja_df)

summary(dep_diff_lm) # Less depressive symptoms for older adults

```

## Pre-Confidence
```{r}

pre_conf_diff <- full_ja_df %>%
  anova_test(PRE_CONFIDENCEn~AGEGROUP)

pre_conf_diff

pre_conf_diff_lm <- lm(PRE_CONFIDENCEn~AGEGROUP, data = full_ja_df)

summary(pre_conf_diff_lm) # No differences

```


## Post-Confidence
```{r}

post_conf_diff <- full_ja_df %>%
  anova_test(POST_CONFIDENCEn~AGEGROUP)

post_conf_diff

post_conf_diff_lm <- lm(POST_CONFIDENCEn~AGEGROUP, data = full_ja_df)

summary(post_conf_diff_lm) # Difference between young and older - older less confident

estimates(post_conf_diff_lm)

```


## Perceived Advice Accuracy
```{r}

advice_acc_diff <- full_ja_df %>%
  anova_test(PERCEIVED_ADVICE_ACCURACYn~AGEGROUP)

advice_acc_diff

advice_acc_diff_lm <- lm(PERCEIVED_ADVICE_ACCURACYn~AGEGROUP, data = full_ja_df)

summary(advice_acc_diff_lm) # Difference between young and older - Older perceive the advice as less accurate

estimates(advice_acc_diff_lm)

```


## Average Fluid IQ
```{r}

fluidiq_diff <- full_ja_df %>%
  anova_test(AVFLUIDIQ~AGEGROUP)

fluidiq_diff

fluidiq_diff_lm <- lm(AVFLUIDIQ~AGEGROUP, data = full_ja_df)

summary(fluidiq_diff_lm) # No difference

visualize(fluidiq_diff_lm)

```




# Mixed Model Analyses
## Hypothesis 1: With increasing age, and increasing depressive symptoms, 
there would be greater advice-taking.
```{r}

# Get dataframe ready

ja_df1 <- full_ja_df

ja_df1 <- pivot_longer(ja_df1, cols = c("JAR01_WOA":"JAR12_WOA"), 
                       names_to = "JAR", values_to = "WOA")

ja_df1$JAR <- as.factor(ja_df1$JAR)

ja_df1$ID <- as.factor(ja_df1$ID)

## Center age

ja_df1 <- ja_df1 %>% mutate(GMC_AGE = scale(AGEn, scale = FALSE))

## Center DASS

ja_df1 <- ja_df1 %>% mutate(GMC_DASS = scale(DASS, scale = FALSE))

## Basic LMM model

model1 <- lmer(WOA~1 + (1|ID), data = ja_df1)

summary(model1)

## Add jar as random effect

model1.2 <- lmer(WOA~1 + (1|ID) + (1|JAR), data = ja_df1, control=lmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e5)))

summary(model1.2)

anova(model1,model1.2) # Retain model1.2 as baseline

## Add age as fixed effect

model2 <- lmer(WOA~GMC_AGE + (1|ID) + (1|JAR), data = ja_df1, control=lmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e5)))

summary(model2)



```

### Check assumptions
```{r}

#2.1 Linearity of relationships 
linearity_model2 <- plot_model(model2, type = "resid",  show.data = TRUE) 
linearity_model2

#2.3 Normality of residuals
#FOR BOTH 2.2 and 2.3, we're going to use this command from sjPlot (as well as for some of our "other checks" in 2.5)
#sjPlot has a suite of other diagnostic plots for each model - let's run these plots (type = "diag") and save them to a new object
#you'll get a list of plots in one object from this command - we'll pull them in step-by-step
model2_diagnostics <- visualize(model2, plot = "residuals")
model2_diagnostics
## Seem to have two clumps?

tab_model(model2)
```


### Table of model2
```{r}

tab_model(model2, #for model 2
          show.re.var = FALSE, #don't show random effects variances (not typically reported in papers)
          show.icc = FALSE, #don't show ICCs 
          show.se = TRUE, #show standard errors
          show.r2 = FALSE, #sjPlot calculates a psuedo-R2 variable that indicates the variance explained by the model 
          #it uses the logic in this paper: https://royalsocietypublishing.org/doi/10.1098/rsif.2017.0213
          #R2 is controversial for multilevel models and this is not my preferred method of computing it - so I will omit it here
          #If you do want to include a measure of variance explained, I recommend the package R2mlm, which uses the methods from Rights & Sterba, 2019 
          #(https://psycnet.apa.org/doiLanding?doi=10.1037%2Fmet0000184)
          show.ci = 0.95, #I'm printing the 95% confidence intervals
          string.ci = "95% CI", #and labelling that column "95% CI"
          p.val = "satterthwaite", #I'm asking it to calculate p-values using the satterthwaite approximation (same thing lmerTest does)
          collapse.se = TRUE,  #I'm asking for the SE to be collapsed into the same column as the estimate and in brackets (typical APA format)
          string.est = "Estimate (SE)", #and for that column to be called "Estimate (SE)"
          pred.labels = c("Intercept","Age"), #now I'm giving it what I want my predictor variables to be labelled in the order that they
          #appear in the model output (check your output from summary above if you're not sure)
          dv.labels = c("Weight of Advice"), #now I'm saying what I want my outcome variable to be labelled
          file = "model2.html") #what I'd like to save my file as - if you don't want to save yet, don't include this

```


## Add DASS
```{r}
# Add DASS as fixed effect
model3 <- lmer(WOA~GMC_AGE + GMC_DASS + (1|ID), data = ja_df1, control=lmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e5)))
summary(model3)

model3.5 <- lmer(WOA~GMC_AGE*GMC_DASS + (1|ID), data = ja_df1, control=lmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e5)))
summary(model3.5)

# Compare main effects and interaction models
anova(model3, model3.5)

model.comparison(model3, model3.5)

```

### Tab models
```{r}
tab_model(model3, #for model 2
          show.re.var = TRUE, #don't show random effects variances (not typically reported in papers)
          show.icc = TRUE, #don't show ICCs 
          show.se = TRUE, #show standard errors
          show.ci = 0.95, #I'm printing the 95% confidence intervals
          string.ci = "95% CI", #and labelling that column "95% CI"
          p.val = "satterthwaite", 
          collapse.se = TRUE,  
          string.est = "Estimate (SE)", #and for that column to be called "Estimate (SE)"
          pred.labels = c("Intercept","Age", "Depressive Symptoms Score"), 
          dv.labels = c("Weight of Advice"), #now I'm saying what I want my outcome variable to be labelled
          file = "model3.html") 

tab_model(model3.5, #for model 2
          show.re.var = TRUE, #don't show random effects variances (not typically reported in papers)
          show.icc = TRUE, #don't show ICCs 
          show.se = TRUE, #show standard errors
          show.ci = 0.95, #I'm printing the 95% confidence intervals
          string.ci = "95% CI", #and labelling that column "95% CI"
          p.val = "satterthwaite", 
          collapse.se = TRUE,  
          string.est = "Estimate (SE)", #and for that column to be called "Estimate (SE)"
          pred.labels = c("Intercept","Age", "Depressive Symptoms Score",
                          "Age X Depressive Symptoms Score"), 
          dv.labels = c("Weight of Advice"), #now I'm saying what I want my outcome variable to be labelled
          file = "model3.5.html")

```



# Create column for emotion regulators
```{r}
ja_df1$EMO_REGn <- as.factor(ja_df1$EMO_REGn)
ja_df2 <- ja_df1 %>% 
  rowwise() %>% 
  mutate(EMO_REGULATOR = ifelse(is.na(EMO_REG_EFFORT1n) & is.na(EMO_REG_EFFORT2n),
                                                            "NO", "YES"))
```


# LMM with emotion regulators and age
```{r}
model4 <- lmer(WOA~GMC_AGE + EMO_REGULATOR + (1|ID), data = ja_df2, control=lmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e5)))
summary(model4)
model5 <- lmer(WOA~GMC_AGE*EMO_REGULATOR + (1|ID), data = ja_df2, control=lmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e5)))
summary(model5)

```

## LMM with emotion regulators and DASS
```{r}

model6 <- lmer(WOA~GMC_AGE + GMC_DASS + EMO_REGULATOR + (1|ID), data = ja_df2, control=lmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e5)))
summary(model6)

model7 <- lmer(WOA~GMC_DASS + GMC_AGE*EMO_REGULATOR + (1|ID), data = ja_df2, control=lmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e5)))
summary(model7)

anova(model6, model7)

model8 <- lmer(WOA~GMC_AGE + GMC_DASS*EMO_REGULATOR + (1|ID), data = ja_df2, control=lmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e5)))
summary(model8)

anova(model6, model8)

# Keep model 8 as it controls for age.

model9 <- lmer(WOA~GMC_AGE*GMC_DASS + EMO_REGULATOR + (1|ID), data = ja_df2, control=lmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e5)))
summary(model9)

anova(model4,model9)

summary(model4) # Without DASS

model10 <- lmer(WOA~GMC_AGE*GMC_DASS*EMO_REGULATOR + (1|ID), data = ja_df2, control=lmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e5)))

anova(model8, model10)

summary(model8) ### Significant depressive symptoms and emotion regulation interaction

```

### Plot interaction

```{r}

graph_model(model8, y=WOA, x=GMC_DASS, lines=EMO_REGULATOR)


```

### Check assumptions
```{r}
#2.1 Linearity of relationships 
linearity_model8 <- plot_model(model8, type = "resid",  show.data = TRUE) 
linearity_model8
#2.3 Normality of residuals
#FOR BOTH 2.2 and 2.3, we're going to use this command from sjPlot (as well as for some of our "other checks" in 2.5)
#sjPlot has a suite of other diagnostic plots for each model - let's run these plots (type = "diag") and save them to a new object
#you'll get a list of plots in one object from this command - we'll pull them in step-by-step
model8_diagnostics1 <- visualize(model8, plot = "residuals")
model8_diagnostics1

tab_model(model8)

model8_diagnostics2 <- modelDiagnostics(model8, ev.perc = .001)

plot(model8_diagnostics2, ask = FALSE, ncol = 2, nrow = 3)

```


## Robust lmm
```{r}

model8_robust <- rlmer(WOA~GMC_AGE + GMC_DASS*EMO_REGULATOR + (1|ID), data = ja_df2, control=lmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e5)))

summary(model8_robust)

summary(model8)

```

##### Diagnostics on robust lmm
```{r}
plot(model8_robust)

visualize(model8_robust, plot = "residuals")

tab_model(model8_robust)

plot_model(model8_robust, type = "resid",  show.data = TRUE, show.loess = FALSE) 


# Use the robust model given normality violations - cite Field & Wilcox 2017

```


### Visualisations and report for robust model
```{r}

## Tab model report
tab_model(model8_robust,
          show.re.var = FALSE, 
          show.icc = FALSE, #don't show ICCs 
          show.se = TRUE,
          show.ci = 0.95, 
          string.ci = "95% CI", 
          collapse.se = TRUE,  
          string.est = "Estimate (SE)", 
          pred.labels = c("Intercept","Age", "Depressive Symptom Score", 
                          "Emotion Regulation Used (Yes)", 
                          "Depressive Symptom Score*Emotion Regulation Used (Yes)"), 
          dv.labels = c("Weight of Advice"), #now I'm saying what I want my outcome variable to be labelled
          file = "model8_Robust.html")


## Visualisation of model
plot_model(model8_robust)
```


### Post hoc on interaction
```{r}

mod8_emm <- emtrends(model8_robust, var = "GMC_DASS", 
                     pairwise~GMC_DASS*EMO_REGULATOR)

mod8_emm


## Visualisation

# Make apatheme

apatheme=theme_bw()+
  theme(panel.grid.major=element_blank(),
        panel.grid.minor=element_blank(),
        panel.border=element_blank(),
        axis.line=element_line(),
        text=element_text(family="Times New Roman"))

plot_model8_int <- plot_model(model8_robust, type = "pred", #can use the same model type as before from sjplot
                                terms = c("GMC_DASS", "EMO_REGULATOR"), #enter the predictor first
                                #so it'll appear on the x-axis, and the moderator second as different lines
                                #I'm asking for just -1SD and + 1SD above the mean of the moderator
                                #I took the specific numbers from from the output of 
                                #the sim_slopes command above (just rounding those) 
                                #if you don't do this, it automatically also includes a line at the mean 
                                #as well - up to you if you want to do that. 
                                title = " ", 
                                axis.title = c("Depressive Symptom Score (grand-mean centered)", "Weight of Advice"), 
                                legend.title = "Emotion Regulator", #adding a title to the legend
                                show.data = TRUE, dot.size = 0.8, jitter = 0.2, 
                                ci.lvl = 0.95) + apatheme
plot_model8_int 

```


# Visualisations
```{r}

# DASS by WOA
flexplot(WOA~DASS, data=ja_df2)
# AGE by WOA
flexplot(WOA~AGEn, data=ja_df2)
# AvFluidIQ by WOA
flexplot(AVFLUIDIQ~WOA, data=ja_df2)
# Perceived Advice Accuracy by WOA
flexplot(WOA~PERCEIVED_ADVICE_ACCURACYn, data=ja_df2)
# Pre confidence by WOA
flexplot(WOA~PRE_CONFIDENCEn, data=ja_df2)
# Post confidence by WOA
flexplot(WOA~POST_CONFIDENCEn, data=ja_df2)
# Emotion regulation by WOA
flexplot(WOA~EMO_REGn, data=ja_df2)




```
# Correlation
## Hypothesis 2: Depressive symptoms in older age either associated directly with a decline in cognitive ability, or via increased emotion regulation. 
###In both cases, reduced cognitive capacity was expected to be associated with increased advice-taking 

### Prepare data for correlations
```{r}
# Rename emotion regulation effort 1 to effort in change
ja_df2$EMO_CHNG_EFFORT <- ja_df2$EMO_REG_EFFORT1n

# Rename emotion regulation effort 2 to effort in acceptance
ja_df2$EMO_ACPT_EFFORT <- ja_df2$EMO_REG_EFFORT2n

# Pivot back wider

ja_df3 <- spread(ja_df2, JAR, WOA)

# Create Grand Mean Centered 

ja_df3 <- ja_df3 %>% mutate(EMO_CHNG_EFFORT_GMC  = scale(EMO_CHNG_EFFORT, center = TRUE, scale = FALSE))

ja_df3 <- ja_df3 %>% mutate(EMO_ACPT_EFFORT_GMC  = scale(EMO_ACPT_EFFORT, center = TRUE, scale = FALSE))

# Make average WOA for each person

ja_df3 <- ja_df3 %>% 
  rowwise() %>% 
  mutate(AVG_WOA = mean(c(JAR01_WOA, JAR02_WOA, JAR03_WOA, JAR04_WOA,
                          JAR05_WOA, JAR06_WOA, JAR07_WOA, JAR08_WOA,
                          JAR09_WOA, JAR10_WOA, JAR11_WOA, JAR12_WOA), 
                        na.rm=TRUE))

# Select variables for correlation

cor_df <- select(ja_df3, AGEn, DASS, EMO_REGULATOR, PRE_CONFIDENCEn, POST_CONFIDENCEn,
                 PERCEIVED_ADVICE_ACCURACYn, AVFLUIDIQ, AVG_WOA)

# Change factored levels of emotion regulator

cor_df$EMO_REGULATOR <- gsub("NO", "0", cor_df$EMO_REGULATOR)

cor_df$EMO_REGULATOR <- gsub("YES", "1", cor_df$EMO_REGULATOR)

cor_df$EMO_REGULATOR <- as.numeric(cor_df$EMO_REGULATOR)

structure(cor_df)

# Split by emo regulation types

cor_df_chg <- ja_df3 %>% filter(EMO_CHNG_EFFORT >= 1)

cor_df_chg <- select(cor_df_chg, AGEn, DASS, EMO_CHNG_EFFORT, PRE_CONFIDENCEn, POST_CONFIDENCEn,
                 PERCEIVED_ADVICE_ACCURACYn, AVFLUIDIQ, AVG_WOA)

cor_df_acpt <- ja_df3 %>% filter(EMO_ACPT_EFFORT >= 1)

cor_df_acpt <- select(cor_df_acpt, AGEn, DASS, EMO_ACPT_EFFORT, PRE_CONFIDENCEn, POST_CONFIDENCEn,
                 PERCEIVED_ADVICE_ACCURACYn, AVFLUIDIQ, AVG_WOA)


```

### Functions to create APA matrix table
```{r}
# mat A matrix or data frame
# p A matrix with the same dimension as `mat`
# f A function to apply
#' @return `mat` with `f` applied to each cell where `p` is TRUE.
#' @examples
#' x <- rbind(c(1,2,3), c(4,5,6), c(7,8,9))
#' apply_if(x, upper.tri(x), function(x) x + 5)
#' 
apply_if <- function(mat, p, f) {
  # Fill NA with FALSE
  p[is.na(p)] <- FALSE
  mat[p] <- f(mat[p])
  mat
}

#' @param mat an rcorr object or a double matrix
#' @param corrtype is either pearson or spearman. Will be passed into Hmsic::rcorr if mat is not already an rcorr object
#' @return `mat` with stars appended for each level of significants (p < 0.05, p < 0.01, p < 0.001)
apaCorr <- function(mat, corrtype = "pearson") {
  matCorr <- mat
  if (class(matCorr) != "rcorr") {
    matCorr <- rcorr(mat, type = corrtype)
  }

  # Add one star for each p < 0.05, 0.01, 0.001
  stars <- apply_if(round(matCorr$r, 2), matCorr$P < 0.05, function(x) paste0(x, "*"))
  stars <- apply_if(stars, matCorr$P < 0.01, function(x) paste0(x, "*"))
  stars <- apply_if(stars, matCorr$P < 0.001, function(x) paste0(x, "*"))
  # Put - on diagonal and blank on upper diagonal
  stars[upper.tri(stars, diag = T)] <- "-"
  stars[upper.tri(stars, diag = F)] <- ""
  n <- length(stars[1,])
  colnames(stars) <- 1:n
  # Remove _ and convert to title case
  row.names(stars) <- tools::toTitleCase(sapply(row.names(stars), gsub, pattern="_", replacement = " "))
  # Add index number to row names
  row.names(stars) <- paste(paste0(1:n,"."), row.names(stars))
  stars
}

```


#### Correlation matrix for all
```{r}

rcorr(as.matrix(cor_df), type = "spearman")

fullcorr <- apaCorr(as.matrix(cor_df), corrtype = "spearman")

fullcor_out <- kable(fullcorr, format = "html")

# Save the table

readr::write_file(fullcor_out, "fullcor_out.html")

# Do not think this correlation is appropriate due to emotion regulator being
# a dichotomous catagorical variable.

```

#### Correlation matrix for change emotions regulators
```{r}

chg_corr <- apaCorr(as.matrix(cor_df_chg), corrtype = "spearman")

chg_corr


chg_corr_out <- kable(chg_corr, format = "html")

# Save the table

readr::write_file(chg_corr_out, "chg_corr_out.html")

# Visualisation of some sig relationships

# Age and perceived advice accuracy
ggscatter(cor_df_chg, x = "AGEn", y = "PERCEIVED_ADVICE_ACCURACYn", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "spearman",
          xlab = "Age", ylab = "Perceived Advice Accuracy")

# Emotion regulation change effort and depressive symptoms
ggscatter(cor_df_chg, x = "EMO_CHNG_EFFORT", y = "DASS", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "spearman")

# Depressive symptoms and fluid IQ
ggscatter(cor_df_chg, x = "DASS", y = "AVFLUIDIQ", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "spearman")

# Advice accuracy and WOA
ggscatter(cor_df_chg, x = "PERCEIVED_ADVICE_ACCURACYn", y = "AVG_WOA", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "spearman")

cor_df_chg %>% 
  get_summary_stats()

```

#### Correlation matrix for accept emotions regulators
```{r}

acpt_corr <- apaCorr(as.matrix(cor_df_acpt), corrtype = "spearman")

acpt_corr_out <- kable(acpt_corr, format = "html")

# Save the table

readr::write_file(acpt_corr_out, "acpt_corr_out.html")

# Visualisation of some sig relationships

# Age and depressive symptoms
ggscatter(cor_df_acpt, x = "AGEn", y = "DASS", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "spearman")

# Depressive symptoms and perceived advice accuracy
ggscatter(cor_df_acpt, x = "DASS", y = "PERCEIVED_ADVICE_ACCURACYn", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "spearman")

cor_df_acpt %>% 
  get_summary_stats()

```

### Correlation matrix for non-emotion regulators
```{r}

# Select variables for correlation

no_er_cor_df <- select(ja_df3, AGEn, DASS, EMO_REGULATOR, PRE_CONFIDENCEn, POST_CONFIDENCEn,
                 PERCEIVED_ADVICE_ACCURACYn, AVFLUIDIQ, AVG_WOA)

no_er_cor_df <- no_er_cor_df %>% filter(EMO_REGULATOR == "NO")

# Select variables again - exclude emo regulator

no_er_cor_df <- select(no_er_cor_df, AGEn, DASS, PRE_CONFIDENCEn, POST_CONFIDENCEn,
                 PERCEIVED_ADVICE_ACCURACYn, AVFLUIDIQ, AVG_WOA)

no_er_corr <- apaCorr(as.matrix(no_er_cor_df), corrtype = "spearman")

no_er_corr_out <- kable(no_er_corr, format = "html")

# Save the table

readr::write_file(no_er_corr_out, "no_er_corr_out.html")

# Visualisation of some sig relationships

# Depressive symptoms and WOA
ggscatter(no_er_cor_df, x = "DASS", y = "AVG_WOA", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "spearman")

no_er_cor_df %>% 
  get_summary_stats()

```


# Look more at emotion regulation effects
```{r}

# Take to only the emotion regulators

emodf <- ja_df3 %>% filter(EMO_REGULATOR == "YES")

# Pivot data longer by woa and jar

emodf <- pivot_longer(emodf, cols = c(JAR01_WOA:JAR12_WOA), 
                      names_to = "JAR", values_to = "WOA")

# Pivot data longer by emotion regulation effort and emotion regulation type

emodf <- pivot_longer(emodf, cols = c(EMO_CHNG_EFFORT_GMC, EMO_ACPT_EFFORT_GMC), 
                      names_to = "REGULATION_TYPE", values_to = "EMO_EFFORT")

# Get rid of rows with NA

emodf <- emodf[complete.cases(emodf[,c("EMO_EFFORT")]),]

# Set regulation type as factor
emodf$REGULATION_TYPE <- as.factor(emodf$REGULATION_TYPE)

# Center avg fluid IQ

emodf <- emodf %>% mutate(GMC_FLUIDIQ = scale(AVFLUIDIQ, scale = FALSE))

```


## LMM with Emotion Effort
```{r}

model11 <- lmer(WOA~EMO_EFFORT + REGULATION_TYPE + GMC_AGE + GMC_FLUIDIQ + GMC_DASS +
                  (1|ID), data = emodf, control=lmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e5)))



model12 <- lmer(WOA~EMO_EFFORT*REGULATION_TYPE + GMC_AGE + GMC_FLUIDIQ + GMC_DASS +
                  (1|ID), data = emodf, control=lmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e5)))


anova(model11, model12)

model13 <- lmer(WOA~EMO_EFFORT*GMC_DASS + REGULATION_TYPE + GMC_AGE + GMC_FLUIDIQ + 
                  (1|ID), data = emodf, control=lmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e5)))

anova(model11, model13)


model14 <- lmer(WOA~EMO_EFFORT + REGULATION_TYPE*GMC_DASS + GMC_AGE + GMC_FLUIDIQ + 
                  (1|ID), data = emodf, control=lmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e5)))


anova(model11, model14)

model15 <- lmer(WOA~EMO_EFFORT*GMC_FLUIDIQ + REGULATION_TYPE + GMC_DASS + GMC_AGE + 
                  (1|ID), data = emodf, control=lmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e5)))


anova(model11, model15)

model16 <- lmer(WOA~EMO_EFFORT + REGULATION_TYPE*GMC_FLUIDIQ + GMC_DASS + GMC_AGE + 
                  (1|ID), data = emodf, control=lmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e5)))

anova(model11, model16)

model17 <- lmer(WOA~EMO_EFFORT + REGULATION_TYPE + GMC_FLUIDIQ*GMC_AGE + GMC_DASS + 
                  (1|ID), data = emodf, control=lmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e5)))

anova(model11, model17)

model18 <- lmer(WOA~EMO_EFFORT + REGULATION_TYPE + GMC_FLUIDIQ + GMC_AGE*GMC_DASS + 
                  (1|ID), data = emodf, control=lmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e5)))

anova(model11, model18)

model19 <- lmer(WOA~EMO_EFFORT + REGULATION_TYPE + GMC_AGE + GMC_FLUIDIQ*GMC_DASS + 
                  (1|ID), data = emodf, control=lmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e5)))

anova(model11, model19)

summary(model11) # Retain the first model - nothing else really improves it.

```

### Add in fluid IQ interactions
```{r}

model20 <- lmer(WOA~GMC_AGE + GMC_DASS + EMO_EFFORT + GMC_FLUIDIQ +
                  (1|ID), data = emodf, control=lmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e5)))


model21 <- lmer(WOA~GMC_AGE + GMC_DASS + EMO_EFFORT*GMC_FLUIDIQ +
                  (1|ID), data = emodf, control=lmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e5)))

summary(model20, model21)

model22 <- lmer(WOA~GMC_AGE + GMC_DASS + EMO_EFFORT + REGULATION_TYPE + GMC_FLUIDIQ +
                  (1|ID), data = emodf, control=lmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e5)))

model23 <- lmer(WOA~GMC_AGE + GMC_DASS + EMO_EFFORT + REGULATION_TYPE*GMC_FLUIDIQ +
                  (1|ID), data = emodf, control=lmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e5)))

anova(model22, model23)

anova(model20, model22)

# Stick with model 20

summary(model20)

```


# Confidence and perceived accuracy
```{r}

# Grand mean center pre-confidence

ja_df4 <- ja_df3 

## The centering is not working properly - Need to do manually and then recalcuate this.
## Then go on to do the mixed models but keep track of them in the paper!

# manually get the mean
pre_conf_m <- ja_df4 %>% 
  get_summary_stats(PRE_CONFIDENCEn, type = "mean_sd")

# Create grand mean centered confidence
ja_df4 <- ja_df4 %>% 
  rowwise() %>%
  mutate(GMC_PRE_CONF = (PRE_CONFIDENCEn - pre_conf_m$mean)) 

# manually get the mean
post_conf_m <- ja_df4 %>% 
  get_summary_stats(POST_CONFIDENCEn, type = "mean_sd")

ja_df4 <- ja_df4 %>% mutate(GMC_POST_CONF = (POST_CONFIDENCEn - post_conf_m$mean)) 

# manually get the mean
adv_acc_m <- ja_df4 %>% 
  get_summary_stats(PERCEIVED_ADVICE_ACCURACYn, type = "mean_sd")

# Grand mean center perceived advice accuracy
ja_df4 <- ja_df4 %>% 
  rowwise() %>%  
  mutate(GMC_PERCEIVED_ACC = (PERCEIVED_ADVICE_ACCURACYn - adv_acc_m$mean))

# Pivot longer by WOA and Jar

ja_df4 <- pivot_longer(ja_df4, cols = c("JAR01_WOA":"JAR12_WOA"), 
                       names_to = "JAR", values_to = "WOA")

ja_df4$JAR <- as.factor(ja_df4$JAR)


```


## LMM
```{r}

# Main effects only
model24 <- lmer(WOA~GMC_AGE + GMC_DASS + GMC_PRE_CONF + (1|ID), data = ja_df4,  control=lmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e5)))

summary(model24)

model25 <- lmer(WOA~GMC_AGE*GMC_PRE_CONF + GMC_DASS +
                  (1|ID), data = ja_df4,  control=lmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e5)))

summary(model25)

anova(model24, model25)

model26 <- lmer(WOA~GMC_AGE + GMC_DASS*GMC_PRE_CONF +
                  (1|ID), data = ja_df4,  control=lmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e5)))

summary(model26)

anova(model24, model26)


```

# Emotion regulators
## Types of emotion regulation
```{r}

# Create categorical variable
# Use case_when instead of ifelse

ja_df4 <- ja_df4 %>% 
  mutate(EMO_REG_TYPE = case_when(EMO_CHNG_EFFORT > 0 ~ "CHANGE",
                                   EMO_ACPT_EFFORT > 0 ~ "ACCEPT",
                                   TRUE ~ "NONE"))
  
# Set as a factor

ja_df4$EMO_REG_TYPE <- as.factor(ja_df4$EMO_REG_TYPE)

levels(ja_df4$EMO_REG_TYPE) <- c("NONE", "ACCEPT", "CHANGE")

levels(ja_df4$EMO_REG_TYPE)


# Create one emotion regulation effort variable

ja_df4 <- ja_df4 %>% 
  mutate(EMO_REG_EFFORT = case_when(is.na(EMO_CHNG_EFFORT) & is.na(EMO_ACPT_EFFORT)~ NA_real_,
                                    !is.na(EMO_CHNG_EFFORT) & is.na(EMO_ACPT_EFFORT)~ as.numeric(EMO_CHNG_EFFORT),
                                    is.na(EMO_CHNG_EFFORT) & !is.na(EMO_ACPT_EFFORT)~ as.numeric(EMO_ACPT_EFFORT),
                                    TRUE ~ 0))

# Center emotion regulation effort variable

# manually get the mean
emo_effort_m <- ja_df4 %>% 
  get_summary_stats(EMO_REG_EFFORT, type = "mean_sd")

ja_df4 <- ja_df4 %>% mutate(GMC_EMO_REG_EFFORT = (EMO_REG_EFFORT - emo_effort_m$mean)) 

```

## Make fluid IQ a GMC variable
```{r}

# manually get the mean
fluidiq_m <- ja_df4 %>% 
  get_summary_stats(AVFLUIDIQ, type = "mean_sd")

# Create grand mean centered confidence
ja_df4 <- ja_df4 %>% 
  rowwise() %>%
  mutate(GMC_FLUIDIQ = (AVFLUIDIQ - fluidiq_m$mean)) 


```

## Exploratory LMM 
```{r}


model27 <- lmer(WOA~GMC_AGE + GMC_DASS + EMO_REG_TYPE*GMC_EMO_REG_EFFORT + GMC_FLUIDIQ + 
                  (1|ID), data = ja_df4,  control=lmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e5)))

summary(model27)

model28 <- lmer(WOA~GMC_AGE*GMC_DASS + EMO_REG_TYPE*GMC_EMO_REG_EFFORT + GMC_FLUIDIQ + 
                  (1|ID), data = ja_df4,  control=lmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e5)))

anova(model27, model28) # Retain model 27

summary(model28)

model29 <- lmer(WOA~GMC_AGE + GMC_DASS*EMO_REG_TYPE + EMO_REG_TYPE*GMC_EMO_REG_EFFORT + GMC_FLUIDIQ + 
                  (1|ID), data = ja_df4,  control=lmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e5)))

anova(model27, model29)

summary(model29) # Retain model 27

tab_model(model29)

model30 <- lmer(WOA~GMC_AGE + GMC_DASS*GMC_EMO_REG_EFFORT + EMO_REG_TYPE*GMC_EMO_REG_EFFORT + GMC_FLUIDIQ + 
                  (1|ID), data = ja_df4,  control=lmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e5)))

anova(model27, model30)

summary(model30) # Retain model27

# Add in perceived advice accuracy and pre-confidence

model31 <- lmer(WOA~GMC_AGE + GMC_DASS + EMO_REG_TYPE*GMC_EMO_REG_EFFORT + GMC_FLUIDIQ + GMC_PRE_CONF + GMC_PERCEIVED_ACC +
                  (1|ID), data = ja_df4,  control=lmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e5)))

anova(model27, model31) # Retain model 31


model32 <- lmer(WOA~GMC_AGE + EMO_REG_TYPE*GMC_EMO_REG_EFFORT + GMC_FLUIDIQ + GMC_PRE_CONF + GMC_DASS*GMC_PERCEIVED_ACC +
                  (1|ID), data = ja_df4,  control=lmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e5)))

anova(model31, model32) # Retain model 31

model33 <- lmer(WOA~GMC_AGE + EMO_REG_TYPE*GMC_EMO_REG_EFFORT + GMC_FLUIDIQ + GMC_PRE_CONF*GMC_DASS + GMC_PERCEIVED_ACC +
                  (1|ID), data = ja_df4,  control=lmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e5)))

anova(model31, model33)

summary(model33) # Retain model 31

model34 <- lmer(WOA~GMC_AGE + GMC_DASS + EMO_REG_TYPE*GMC_EMO_REG_EFFORT + GMC_FLUIDIQ + GMC_PRE_CONF + EMO_REG_TYPE*GMC_PERCEIVED_ACC +
                  (1|ID), data = ja_df4,  control=lmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e5)))

anova(model31, model34)

# Retain model 30

summary(model34)


model35 <- lmer(WOA~GMC_AGE + EMO_REG_EFFORT*GMC_DASS + EMO_REG_TYPE*GMC_EMO_REG_EFFORT + GMC_PRE_CONF + GMC_PERCEIVED_ACC + GMC_FLUIDIQ +
                  (1|ID), data = ja_df4,  control=lmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e5)))

anova(model31, model35)

summary(model35) # Retain model31

### Models without emotion regulation effort included ####

model36 <- lmer(WOA~GMC_AGE + GMC_DASS*EMO_REG_TYPE + GMC_FLUIDIQ + GMC_PRE_CONF + GMC_PERCEIVED_ACC +
                  (1|ID), data = ja_df4,  control=lmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e5)))

summary(model36)

model37 <- lmer(WOA~GMC_AGE + GMC_DASS + EMO_REG_TYPE + GMC_FLUIDIQ + GMC_PRE_CONF + GMC_PERCEIVED_ACC +
                  (1|ID), data = ja_df4,  control=lmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e5)))

anova(model36, model37) # Retain model 36

summary(model31)


```

### Check assumptions
```{r}

#2.1 Linearity of relationships 
linearity_model36 <- plot_model(model36, type = "resid",  show.data = TRUE) 
linearity_model36
#2.3 Normality of residuals
#FOR BOTH 2.2 and 2.3, we're going to use this command from sjPlot (as well as for some of our "other checks" in 2.5)
#sjPlot has a suite of other diagnostic plots for each model - let's run these plots (type = "diag") and save them to a new object
#you'll get a list of plots in one object from this command - we'll pull them in step-by-step
model36_diagnostics1 <- visualize(model32, plot = "residuals")
model32_diagnostics1

tab_model(model32)

model32_diagnostics2 <- modelDiagnostics(model32, ev.perc = .001)

plot(model32_diagnostics2, ask = FALSE, ncol = 2, nrow = 3)

```

#### Robust LMM
```{r}
model31_robust <- rlmer(WOA~GMC_AGE + GMC_DASS + EMO_REG_TYPE*GMC_EMO_REG_EFFORT + GMC_FLUIDIQ + GMC_PRE_CONF + GMC_PERCEIVED_ACC +
                          (1|ID), data = ja_df4, control=lmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e5)))

summary(model31_robust)

summary(model31)

model36_robust <- rlmer(WOA~GMC_AGE + GMC_DASS*EMO_REG_TYPE + GMC_FLUIDIQ + GMC_PRE_CONF + GMC_PERCEIVED_ACC +
                          (1|ID), data = ja_df4, control=lmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e5)))

summary(model36_robust)

summary(model36)
```

##### Diagnostics on robust lmm
```{r}
plot(model31_robust)

plot(model36_robust)

tab_model(model31_robust)

tab_model(model36_robust)

plot_model(model31_robust, type = "resid",  show.data = TRUE, show.loess = FALSE) 

plot_model(model36_robust, type = "resid",  show.data = TRUE, show.loess = FALSE) 

# Use the robust model given normality violations - cite Field & Wilcox 2017

```


### Visualisations and report for robust model
```{r}

## Tab model report
tab_model(model31_robust,
          show.re.var = FALSE, 
          show.icc = FALSE, #don't show ICCs 
          show.se = TRUE,
          show.ci = 0.95, 
          string.ci = "95% CI", 
          collapse.se = TRUE,  
          string.est = "Estimate (SE)", 
          #pred.labels = c("Intercept","Age", "Emotion Regulation (Accept)", 
                        #  "Emotion Regulation (Change)", 
                        #  "Depressive Symptom Score", "Pre-Confidence Score",
                        #  "Perceived Advice Accuracy", 
                        #  "Emotion Regulation (Accept)*DSS",
                        #  "Emotion Regulation (Change)*DSS"), 
          dv.labels = c("Weight of Advice"), #now I'm saying what I want my outcome variable to be labelled
          file = "model31_Robust.html")


## Visualisation of model
plot_model(model31_robust)

## Tab model report
tab_model(model36_robust,
          show.re.var = FALSE, 
          show.icc = FALSE, #don't show ICCs 
          show.se = TRUE,
          show.ci = 0.95, 
          string.ci = "95% CI", 
          collapse.se = TRUE,  
          string.est = "Estimate (SE)", 
         # pred.labels = c("Intercept","Age", "Emotion Regulation (Accept)", 
                      #    "Emotion Regulation (Change)", 
                       #   "Depressive Symptom Score", "Pre-Confidence Score",
                       #   "Perceived Advice Accuracy", 
                       #   "Emotion Regulation (Accept)*DSS",
                        #  "Emotion Regulation (Change)*DSS"), 
          dv.labels = c("Weight of Advice"), #now I'm saying what I want my outcome variable to be labelled
          file = "model36_Robust.html")


## Visualisation of model
plot_model(model36_robust)
```


### Post hoc on interaction
```{r}

mod36_emm <- emtrends(model36_robust, var = "GMC_DASS", 
                     pairwise~GMC_DASS*EMO_REG_TYPE)

mod36_emm


## Visualisation

# Make apatheme

apatheme=theme_bw()+
  theme(panel.grid.major=element_blank(),
        panel.grid.minor=element_blank(),
        panel.border=element_blank(),
        axis.line=element_line(),
        text=element_text(family="Times New Roman"))

plot_model36_int <- plot_model(model36_robust, type = "pred", #can use the same model type as before from sjplot
                                terms = c("GMC_DASS", "EMO_REG_TYPE"), #enter the predictor first
                                #so it'll appear on the x-axis, and the moderator second as different lines
                                #I'm asking for just -1SD and + 1SD above the mean of the moderator
                                #I took the specific numbers from from the output of 
                                #the sim_slopes command above (just rounding those) 
                                #if you don't do this, it automatically also includes a line at the mean 
                                #as well - up to you if you want to do that. 
                                title = " ", 
                                axis.title = c("Depressive Symptom Score (grand-mean centered)", "Weight of Advice"), 
                                legend.title = "Emotion Regulation Type", #adding a title to the legend
                                show.data = TRUE, dot.size = 0.8, jitter = 0.2, 
                                ci.lvl = 0.95) + apatheme
plot_model36_int 
```



# Difference between age groups and emo regulation type
## Chi sqare analysis
```{r}
ggplot(ja_df4) +
  aes(x = AGEGROUP, fill = EMO_REG_TYPE) +
  geom_bar(position = "dodge")


chitest <- chisq.test(table(ja_df4$AGEGROUP, ja_df4$EMO_REG_TYPE))
chitest

chitest$expected

```


# Emotion regulation and fluid IQ
```{r}

model39 <- lmer(WOA~GMC_AGE + GMC_DASS*EMO_REG_TYPE + EMO_REG_TYPE*GMC_FLUIDIQ + GMC_PRE_CONF + GMC_PERCEIVED_ACC +
                  (1|ID), data = ja_df4,  control=lmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e5)))

summary(model39)


model40 <- lmer(WOA~GMC_AGE + GMC_DASS*EMO_REG_TYPE + GMC_FLUIDIQ + EMO_REG_TYPE*GMC_PRE_CONF + GMC_PERCEIVED_ACC +
                  (1|ID), data = ja_df4,  control=lmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e5)))

summary(model40)

model41 <- lmer(WOA~GMC_AGE + GMC_DASS*EMO_REG_TYPE + GMC_FLUIDIQ + GMC_PRE_CONF + EMO_REG_TYPE*GMC_PERCEIVED_ACC +
                  (1|ID), data = ja_df4,  control=lmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e5)))

summary(model41)

model42 <- lmer(WOA~EMO_REG_TYPE*GMC_AGE + GMC_DASS*EMO_REG_TYPE + GMC_FLUIDIQ + GMC_PRE_CONF + GMC_PERCEIVED_ACC +
                  (1|ID), data = ja_df4,  control=lmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e5)))

summary(model42)

```


